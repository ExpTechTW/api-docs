---
title: 2025/12/13 TREM Lite 地震報告重複推送問題
authors: [yuyu1015]
tags: [yuyu1015, rca]
---

import SeverityBadge from "@site/src/components/SeverityBadge";
import StatusBadge from "@site/src/components/StatusBadge";
import ImageLightbox from "@site/src/components/ImageLightbox";

<SeverityBadge level="medium" />
<StatusBadge status="investigating" />

---

## 事件概述

- **發生時間：** 2025/12/13 03:33 (UTC+8) 左右
- **觸發條件：** 維護過程中
- **問題描述：** TREM Lite 地震報告重複推送的問題
- **根本原因：** API 資料雜湊值不一致，導致地震報告重複推送

## 時間軸

| 時間 (UTC+8)     | 事件                                 |
| ---------------- | ------------------------------------ |
| 2025/12/13 03:33 | 問題發生：TREM Lite 地震報告重複推送 |
| 2025/12/13 03:53 | 確認問題並開始進行修復               |
| 2025/12/13 03:54 | 執行緊急處理，嘗試緩解問題           |
| 2025/12/13 03:55 | 觀察到問題已緩解                     |

## 事件經過

在進行 TNN Core Server 的維護作業期間，調整 Nginx 設定時將 report server 容器重啟，隨後發生 TREM Lite 地震報告重複推送的問題。
問題發生後，立即進行排查，確認問題根源並執行修復，約 22 分鐘後問題得到緩解。

## 根本原因分析

### 問題根源

兩個不同來源的 API 伺服器（`api-1.exptech.dev` 和 `api-2.exptech.dev`）對於相同的地震事件，產生的 MD5 雜湊值不一致，導致客戶端判斷為新的地震報告，進而產生重複推送的問題。

**關鍵差異：**

從上述 API 回應資料可以觀察到，相同的地震事件（相同的 `id`）在兩個 API 伺服器上：

- `trem` 時間戳不同（例如：`1765484671592` vs `1765484672700`）
- 因此計算出的 `md5` 雜湊值也不同（例如：`B00F1BCF25C80D8A4EAA865D1D8EEC33` vs `DA5510C9B54576B883E04F4DD7178E9C`）

`api-1.exptech.dev`

```json
[
  {
    "id": "114149-2025-1212-042428",
    "lat": 23.19,
    "lon": 120.47,
    "depth": 8.9,
    "loc": "臺南市政府東北方  36.4  公里 (位於臺南市楠西區)",
    "mag": 4,
    "time": 1765484668000,
    "int": 4,
    "trem": 1765484671592,
    "md5": "B00F1BCF25C80D8A4EAA865D1D8EEC33"
  },
  {
    "id": "114148-2025-1211-231940",
    "lat": 23.18,
    "lon": 120.66,
    "depth": 8.2,
    "loc": "高雄市政府北北東方  71.5  公里 (位於高雄市甲仙區)",
    "mag": 4.7,
    "time": 1765466380000,
    "int": 4,
    "trem": 1765466391158,
    "md5": "F2B6AE32A6E4D8A459ECEDFDE19180E6"
  },
  {
    "id": "114000-2025-1211-225941",
    "lat": 23.17,
    "lon": 120.67,
    "depth": 8,
    "loc": "高雄市政府北北東方  71.2  公里 (位於高雄市甲仙區)",
    "mag": 3.5,
    "time": 1765465181000,
    "int": 2,
    "trem": 1765465199063,
    "md5": "685F5C6EC26FBF1F9159906486A5C127"
  },
  {
    "id": "114147-2025-1211-224902",
    "lat": 23.18,
    "lon": 120.66,
    "depth": 8,
    "loc": "高雄市政府北北東方  71.1  公里 (位於高雄市甲仙區)",
    "mag": 4.7,
    "time": 1765464542000,
    "int": 4,
    "trem": 1765464552546,
    "md5": "F34095B26D0895AA0995F3028B76DE02"
  },
  {
    "id": "114000-2025-1211-124902",
    "lat": 24.62,
    "lon": 121.75,
    "depth": 45.4,
    "loc": "宜蘭縣政府南方  12.3  公里 (位於宜蘭縣冬山鄉)",
    "mag": 4,
    "time": 1765428542000,
    "int": 1,
    "trem": 1765428550547,
    "md5": "F1CC648A41D465CA2F60264ACCABC7A3"
  }
]
```

`api-2.exptech.dev`

```json
[
  {
    "id": "114149-2025-1212-042428",
    "lat": 23.19,
    "lon": 120.47,
    "depth": 8.9,
    "loc": "臺南市政府東北方  36.4  公里 (位於臺南市楠西區)",
    "mag": 4,
    "time": 1765484668000,
    "int": 4,
    "trem": 1765484672700,
    "md5": "DA5510C9B54576B883E04F4DD7178E9C"
  },
  {
    "id": "114148-2025-1211-231940",
    "lat": 23.18,
    "lon": 120.66,
    "depth": 8.2,
    "loc": "高雄市政府北北東方  71.5  公里 (位於高雄市甲仙區)",
    "mag": 4.7,
    "time": 1765466380000,
    "int": 4,
    "trem": 1765466391208,
    "md5": "D207D655C1A9E720E7BBC33B1F4CCD33"
  },
  {
    "id": "114000-2025-1211-225941",
    "lat": 23.17,
    "lon": 120.67,
    "depth": 8,
    "loc": "高雄市政府北北東方  71.2  公里 (位於高雄市甲仙區)",
    "mag": 3.5,
    "time": 1765465181000,
    "int": 2,
    "trem": 1765465199151,
    "md5": "25A440BC96AC17E401AEFFFED42CD06C"
  },
  {
    "id": "114147-2025-1211-224902",
    "lat": 23.18,
    "lon": 120.66,
    "depth": 8,
    "loc": "高雄市政府北北東方  71.1  公里 (位於高雄市甲仙區)",
    "mag": 4.7,
    "time": 1765464542000,
    "int": 4,
    "trem": 1765464552550,
    "md5": "24C4744A01521C9540CE2D5FD209AF07"
  },
  {
    "id": "114000-2025-1211-124902",
    "lat": 24.62,
    "lon": 121.75,
    "depth": 45.4,
    "loc": "宜蘭縣政府南方  12.3  公里 (位於宜蘭縣冬山鄉)",
    "mag": 4,
    "time": 1765428542000,
    "int": 1,
    "trem": 0,
    "md5": "6C759AE5E57359B06662C6B0C31B68B1"
  }
]
```

### 問題說明

**問題主因：**

可以從下方圖片發現，兩邊 (`TNN`、`TPE`) 的 **ID** 不一致。

<ImageLightbox src="/img/RCA/2025-12-13_1/image.png" alt="問題說明圖" />

伺服器上的 **MD5 雜湊值** 計算方式如下：

```js
const ans = {
  ...earthquakeData, // CWA 地震報告
  trem, // TREM EQ ID
  md5: calculateMD5Hash(
    JSON.stringify({
      ...earthquakeData,
      trem,
    })
  ).toLocaleUpperCase(), // MD5 雜湊值
};
```

**TREM EQ ID** 的取得方式如下：

```sql
SELECT ID FROM trem_report WHERE Cwa_id = ? LIMIT 1;
```

綜上所述，**MD5 雜湊值** 的不一致最終導致問題的發生。

## 解決方案

## 後續觀察
